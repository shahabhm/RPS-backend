# راهنمای راه‌اندازی سرور

## داکر

### نصب

برای نصب ترجیحا از دستورالعملی که در وبسایت رسمی داکر قرار گرفته است استفاده کنید.
در صورتی که با این دستورالعمل به مشکلی خوردید، می‌توانید از
[این روش
](https://derak.cloud/blog/tech/how-to-install-docker-on-ubuntu/)
استفاده کنید.
در این صورت توجه کنید که بهتر است پلاگین buildx داکر را هم نصب کنید.
برای این کار از دستورالعملی که در
[این لینک](https://docs.docker.com/engine/install/ubuntu/#install-from-a-package)
آمده پیروی کنید.

### پیکربندی

یکی از مشکلات اساسی که احتمالا با داکر وجود خواهد داشت اعمال تحریم از سوی داکر است.
این مشکل ممکن است با ارور 403 یا با ارور 429 خودش را نشان دهد.
برای رفع این مشکل، می‌توان از رجیستری‌های ثانویه داکر استفاده کرد.
از آن‌جایی که سرور ما روی آروان قرار دارد، از رجیستری آروان استفاده می‌کنیم تا سرعت بیشتری داشته باشد.
برای این کار، در فایل
`/etc/docker/daemon.json`،
محتوای زیر را قرار دهید:

```json
{
  "registry-mirrors": ["https://docker.arvancloud.ir"]
}
```

روش‌های دیگری هم در
[این مقاله](https://www.m-fozouni.ir/docker-registry/)
نوشته شده است که می‌توانید استفاده کنید.

## HTTPS

ابرآروان امکانی را در اختیار کاربران قرار می‌دهد که HTTPS را بر روی دامنه‌ی آن‌ها فعال کند و SSL را خودش مدیریت کند.
این گواهینامه بعد از ۳ ماه منقضی می‌شود ولی احتمالا خود آروان کار تمدید آن را انجام دهد.
برای اطلاعات بیشتر، به این لینک مراجعه کنید:
[گواهی‌نامه آروان
](https://docs.arvancloud.ir/fa/cdn/https-settings/arvancloud-certificate)

### نکات مهم

برای درست کار کردن این قابلیت، باید در بخش تنظیمات HTTPS، ارتباط با سرور‌های لبه، گزینه‌های `فعال‌سازی HTTPS` و `پیش‌فرض شدن HTTPS` را فعال کنید.

در قسمت ارتباط با سرور‌های اصلی هم، گزینه‌ی `HTTP` را انتخاب کنید.

با انجام این تنظیمات، لازم نیست که روی سرور و ماشین هیچ گونه تنظیماتی مربوط به HTTPS را انجام دهید و سرور با پروتکل HTTP کار می‌کند که برای دیباگ و تست لوکال بسیار راحت‌تر است، اما ارتباط کاربران با سرور پروداکشن با پروتکل HTTPS خواهد بود و آروان امنیت ارتباط را تامین می‌کند و به سرور داده‌ی رمزگشایی شده را با HTTP تحویل می‌دهد.

## VPN

برای اتصال به رابط برنامه‌نویسی تلگرام و ارسال پیام از طریق بات، لازم است که به اینترنت آزاد دسترسی داشته باشیم.
برای این کار از نرم‌افزار
[V2Raya](https://github.com/v2rayA/v2rayA)
استفاده می‌کنیم که یک کلاینت دسکتاپ برای استفاده از سرور‌های V2Ray دارد.
رابط کاربری این نرم‌افزار روی پورت 2017 سرور در دسترس است.

برای نصب این برنامه از دستورالعمل آن که در
[این لینک](https://v2raya.org/en/docs/prologue/installation/debian/) قرار دارد استفاده می‌کنیم.
بهتر است که برنامه را از snap یا apt بگیرید و ایمیج آن را مستقیم نصب نکنید;
چون ممکن است به خطای v2ray-core یا geo-ip بخورید.
همچنین پورت دیفالت socks5 آن 20170 است ولی ممکن است که این پورت اشغال باشد. اگر مشکل connection refused خوردید مقدار پورت را در تنظیمات بررسی کنید که عوض نشده باشد.
## Firewall

توصیه می‌کنم که به هیچ وجه تنظیمات فایروال سرور را تغییر ندهید.
در این صورت، دسترسی SSH به سرور هم قطع می‌شود و تنها راه ارتباط با سرور و خاموش کردن فایروال، استفاده از ترمینال سایت آروان است.
در این ترمینال، احتمالا به یک رمز عبور برای اوبونتو نیاز خواهید داشت که باید از بخش سرور آن را بردارید
(این پسورد ثابت نیست و هر دفعه باید آن را کپی کنید).

## ENVIRONMENT

از آن‌جایی که دو محیط test و production داریم، برای هر کدام از آن‌ها یک فایل env در نظر گرفته‌ایم.
این فایل‌ها در گیت ignore شده اند و در نتیجه تغییرات آن‌ها باید به روی سرور اعمال شود.
از آن‌جایی که در این فایل توکن‌ها و رمزهای عبور قرار دارد نباید در گیت‌هاب قرار داده شوند.